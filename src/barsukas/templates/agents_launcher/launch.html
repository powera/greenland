{% extends "base.html" %}

{% block title %}Launch {{ agent.display_name }}{% endblock %}

{% block content %}
<div class="py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('agents_launcher.list_agents') }}">Agents</a></li>
            <li class="breadcrumb-item active">{{ agent.display_name }}</li>
        </ol>
    </nav>

    <h1><i class="{{ agent.icon }}"></i> {{ agent.display_name }}</h1>
    <p class="lead">{{ agent.subtitle }}</p>
    <p>{{ agent.description }}</p>

    <hr class="my-4">

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Launch Agent</h5>

            {% if parser_info %}
                <!-- Dynamic Form (from argparse introspection) -->
                <form id="launchForm">
                    {% if parser_info.description %}
                    <p class="text-muted">{{ parser_info.description }}</p>
                    {% endif %}

                    {% for group_name, group_args in argument_groups.items() %}
                        {% if group_args %}
                        <div class="argument-group mb-4">
                            {% if group_name != 'common' %}
                            <h6 class="text-capitalize">{{ group_name }} Mode Arguments</h6>
                            {% else %}
                            <h6>Common Arguments</h6>
                            {% endif %}

                            {% for arg in group_args %}
                            <div class="mb-3">
                                {% if arg.type == 'boolean' %}
                                    <!-- Boolean / Checkbox -->
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               id="arg_{{ arg.dest }}" name="arg_{{ arg.dest }}" value="true"
                                               {% if arg.default %}checked{% endif %}>
                                        <label class="form-check-label" for="arg_{{ arg.dest }}">
                                            {{ arg.names[0] }}
                                            {% if arg.help %}<span class="text-muted small">- {{ arg.help }}</span>{% endif %}
                                        </label>
                                    </div>
                                {% elif arg.type == 'choice' %}
                                    <!-- Choice / Dropdown -->
                                    <label for="arg_{{ arg.dest }}" class="form-label">
                                        {{ arg.names[0] }}
                                        {% if arg.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <select class="form-select" id="arg_{{ arg.dest }}" name="arg_{{ arg.dest }}"
                                            {% if arg.required %}required{% endif %}>
                                        <option value="">-- Select {{ arg.dest }} --</option>
                                        {% for choice in arg.choices %}
                                        <option value="{{ choice }}" {% if choice == arg.default %}selected{% endif %}>
                                            {{ choice }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if arg.help %}
                                    <div class="form-text">{{ arg.help }}</div>
                                    {% endif %}
                                {% elif arg.type == 'list' %}
                                    <!-- List / Multi-select -->
                                    <label for="arg_{{ arg.dest }}" class="form-label">
                                        {{ arg.names[0] }}
                                        {% if arg.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {% if arg.choices %}
                                        <select class="form-select" id="arg_{{ arg.dest }}" name="arg_{{ arg.dest }}"
                                                multiple {% if arg.required %}required{% endif %}>
                                            {% for choice in arg.choices %}
                                            <option value="{{ choice }}">{{ choice }}</option>
                                            {% endfor %}
                                        </select>
                                    {% else %}
                                        <input type="text" class="form-control" id="arg_{{ arg.dest }}" name="arg_{{ arg.dest }}"
                                               placeholder="Comma-separated values"
                                               {% if arg.required %}required{% endif %}>
                                    {% endif %}
                                    {% if arg.help %}
                                    <div class="form-text">{{ arg.help }}</div>
                                    {% endif %}
                                {% elif arg.type in ['integer', 'float'] %}
                                    <!-- Number Input -->
                                    <label for="arg_{{ arg.dest }}" class="form-label">
                                        {{ arg.names[0] }}
                                        {% if arg.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <input type="number" class="form-control" id="arg_{{ arg.dest }}" name="arg_{{ arg.dest }}"
                                           {% if arg.default %}value="{{ arg.default }}"{% endif %}
                                           {% if arg.type == 'float' %}step="0.01"{% endif %}
                                           {% if arg.required %}required{% endif %}>
                                    {% if arg.help %}
                                    <div class="form-text">{{ arg.help }}</div>
                                    {% endif %}
                                {% else %}
                                    <!-- Text Input -->
                                    <label for="arg_{{ arg.dest }}" class="form-label">
                                        {{ arg.names[0] }}
                                        {% if arg.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <input type="text" class="form-control" id="arg_{{ arg.dest }}" name="arg_{{ arg.dest }}"
                                           {% if arg.default %}value="{{ arg.default }}"{% endif %}
                                           {% if arg.metavar %}placeholder="{{ arg.metavar }}"{% endif %}
                                           {% if arg.required %}required{% endif %}>
                                    {% if arg.help %}
                                    <div class="form-text">{{ arg.help }}</div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% endfor %}

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="launchBtn">
                            <i class="bi bi-play-circle"></i> Launch Agent
                        </button>
                        <a href="{{ url_for('agents_launcher.list_agents') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Agents
                        </a>
                    </div>
                </form>
            {% else %}
                <!-- Static Form (predefined modes) -->
                <form id="launchForm">
                    <!-- Mode Selection -->
                    <div class="mb-3">
                        <label for="mode" class="form-label">Select Mode</label>
                        <select class="form-select" id="mode" name="mode">
                            <option value="">-- Select a mode --</option>
                            {% for mode in agent.modes %}
                            <option value="{{ mode.label }}"
                                    data-requires-input="{{ 'true' if mode.get('requires_input') else 'false' }}"
                                    data-input-placeholder="{{ mode.get('input_placeholder', '') }}">
                                {{ mode.label }} - {{ mode.description }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Dynamic Input (for modes that require input like GUID or level) -->
                    <div class="mb-3" id="modeInputContainer" style="display: none;">
                        <label for="modeInput" class="form-label" id="modeInputLabel">Input</label>
                        <input type="text" class="form-control" id="modeInput" name="mode_input" placeholder="">
                    </div>

                    <!-- Custom Arguments -->
                    <div class="mb-3">
                        <label for="customArgs" class="form-label">Additional Arguments (optional)</label>
                        <input type="text" class="form-control" id="customArgs" name="custom_args"
                               placeholder="e.g., --limit 10 --yes">
                        <div class="form-text">
                            Add any additional command-line arguments. Use --help to see all available options.
                        </div>
                    </div>

                    <!-- Dry Run Option -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="dryRun" name="dry_run" value="true">
                        <label class="form-check-label" for="dryRun">
                            Dry run (show what would be done without making changes)
                        </label>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="launchBtn">
                            <i class="bi bi-play-circle"></i> Launch Agent
                        </button>
                        <a href="{{ url_for('agents_launcher.list_agents') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Agents
                        </a>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Output Display -->
    <div id="outputContainer" style="display: none;" class="mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-terminal"></i> Agent Output
                    <span id="statusBadge" class="badge ms-2"></span>
                </h5>
            </div>
            <div class="card-body">
                <div id="outputContent"></div>
            </div>
        </div>
    </div>
</div>

<style>
#outputContent pre {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    max-height: 500px;
    overflow-y: auto;
}

.spinner-border {
    width: 1rem;
    height: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('launchForm');
    const modeSelect = document.getElementById('mode');
    const modeInputContainer = document.getElementById('modeInputContainer');
    const modeInput = document.getElementById('modeInput');
    const modeInputLabel = document.getElementById('modeInputLabel');
    const launchBtn = document.getElementById('launchBtn');
    const outputContainer = document.getElementById('outputContainer');
    const outputContent = document.getElementById('outputContent');
    const statusBadge = document.getElementById('statusBadge');

    // Handle mode selection - show/hide input based on mode requirements
    modeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const requiresInput = selectedOption.getAttribute('data-requires-input') === 'true';
        const placeholder = selectedOption.getAttribute('data-input-placeholder');

        if (requiresInput) {
            modeInputContainer.style.display = 'block';
            modeInput.placeholder = placeholder;
            modeInput.required = true;
        } else {
            modeInputContainer.style.display = 'none';
            modeInput.required = false;
            modeInput.value = '';
        }
    });

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Build form data
        const formData = new FormData(form);

        // For static forms, validate mode selection
        if (modeSelect && !modeSelect.value) {
            alert('Please select a mode');
            return;
        }

        // Show loading state
        launchBtn.disabled = true;
        launchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Launching...';
        outputContainer.style.display = 'none';

        // For static forms with mode input
        if (modeSelect && modeInput && modeInput.value) {
            let customArgs = document.getElementById('customArgs').value;
            customArgs = modeInput.value + (customArgs ? ' ' + customArgs : '');
            formData.set('custom_args', customArgs);
        }

        // Handle multi-select fields (convert to comma-separated string)
        const multiSelects = form.querySelectorAll('select[multiple]');
        multiSelects.forEach(select => {
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
            if (selectedOptions.length > 0) {
                formData.set(select.name, selectedOptions.join(','));
            }
        });

        try {
            // Execute agent
            const response = await fetch('{{ url_for("agents_launcher.execute_agent", agent_name=agent.name) }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // Show output
            outputContainer.style.display = 'block';

            if (result.success) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Success';
                outputContent.innerHTML = `<pre>${escapeHtml(result.stdout)}</pre>`;
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Error';
                outputContent.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${escapeHtml(result.error || 'Unknown error')}
                    </div>
                    ${result.stdout ? '<h6>Standard Output:</h6><pre>' + escapeHtml(result.stdout) + '</pre>' : ''}
                    ${result.stderr ? '<h6>Error Output:</h6><pre>' + escapeHtml(result.stderr) + '</pre>' : ''}
                `;
            }

            // Scroll to output
            outputContainer.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            outputContainer.style.display = 'block';
            statusBadge.className = 'badge bg-danger';
            statusBadge.textContent = 'Error';
            outputContent.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${escapeHtml(error.message)}
                </div>
            `;
        } finally {
            // Reset button
            launchBtn.disabled = false;
            launchBtn.innerHTML = '<i class="bi bi-play-circle"></i> Launch Agent';
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %}
