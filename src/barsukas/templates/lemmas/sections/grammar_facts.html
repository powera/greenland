<!-- Grammar Facts -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-card-list"></i> Grammar Facts</span>
                {% if lemma.pos_type == 'noun' %}
                <div>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#generateGrammarFactModal">
                        <i class="bi bi-plus-circle"></i> Generate Grammar Fact
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if grammar_facts %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Language</th>
                            <th>Fact Type</th>
                            <th>Value</th>
                            <th>Notes</th>
                            <th>Verified</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fact in grammar_facts %}
                        <tr>
                            <td><span class="badge bg-secondary">{{ fact.language_code }}</span></td>
                            <td>{{ fact.fact_type|replace('_', ' ')|title }}</td>
                            <td>
                                {% if fact.language_code == 'zh' %}
                                <span class="chinese-with-pinyin">{{ fact.fact_value|pinyin_ruby|safe }}</span>
                                {% else %}
                                <strong>{{ fact.fact_value }}</strong>
                                {% endif %}
                            </td>
                            <td><small class="text-muted">{{ fact.notes or '-' }}</small></td>
                            <td>
                                {% if fact.verified %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                {% else %}
                                <i class="bi bi-circle text-muted"></i>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle"></i> No grammar facts recorded for this lemma yet.
                    {% if lemma.pos_type == 'noun' %}
                    Use the <strong>Lape agent</strong> to generate language-specific grammar facts like Chinese measure words.
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Generate Grammar Fact Modal (for nouns) -->
{% if lemma.pos_type == 'noun' %}
<div class="modal fade" id="generateGrammarFactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Grammar Fact</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('agents.generate_grammar_fact', lemma_id=lemma.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Lemma</label>
                        <p class="form-control-plaintext"><strong>{{ lemma.lemma_text }}</strong> - {{ lemma.definition_text[:50] }}...</p>
                    </div>
                    <div class="mb-3">
                        <label for="fact_type" class="form-label">Fact Type</label>
                        <select class="form-select" id="fact_type" name="fact_type" required>
                            <option value="measure_words">Measure Words (Chinese classifiers)</option>
                            <option value="grammatical_gender">Grammatical Gender</option>
                            <!-- Future options:
                            <option value="number_type">Number Type (Plurale tantum, Singulare tantum)</option>
                            <option value="declension_class">Declension Class (Lithuanian, Latin, etc.)</option>
                            -->
                        </select>
                        <small class="form-text text-muted">
                            Select the type of grammar fact to generate
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="language_code" class="form-label">Language</label>
                        <select class="form-select" id="grammar_fact_language_code" name="language_code" required>
                            <!-- Options populated by JavaScript based on fact type -->
                        </select>
                        <small class="form-text text-muted">
                            Language for the grammar fact
                        </small>
                    </div>
                    <div class="alert alert-info" id="grammar_fact_description">
                        <i class="bi bi-info-circle"></i>
                        <span id="grammar_fact_description_text">
                            Select a fact type to see description
                        </span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-robot"></i> Generate with AI
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Grammar fact type configuration
const GRAMMAR_FACT_TYPES = {
    'measure_words': {
        languages: ['zh'],
        languageNames: {'zh': 'Chinese'},
        description: 'The Lape agent uses AI to determine the appropriate Chinese classifier/measure word (量词) for this noun. The measure word is required when using numbers with nouns in Chinese.'
    },
    'grammatical_gender': {
        languages: ['fr', 'lt', 'es', 'de', 'pt', 'ru', 'it'],
        languageNames: {
            'fr': 'French',
            'lt': 'Lithuanian',
            'es': 'Spanish',
            'de': 'German',
            'pt': 'Portuguese',
            'ru': 'Russian',
            'it': 'Italian'
        },
        description: 'The Lape agent uses AI to determine the grammatical gender (masculine, feminine, neuter) for this noun in the selected language.'
    }
};

function updateGrammarFactLanguages() {
    const factType = document.getElementById('fact_type').value;
    const languageSelect = document.getElementById('grammar_fact_language_code');
    const descriptionText = document.getElementById('grammar_fact_description_text');
    const config = GRAMMAR_FACT_TYPES[factType];

    if (!config) return;

    // Clear and populate language options
    languageSelect.innerHTML = '';
    config.languages.forEach((langCode, index) => {
        const option = document.createElement('option');
        option.value = langCode;
        option.textContent = `${config.languageNames[langCode]} (${langCode})`;
        if (index === 0) option.selected = true;
        languageSelect.appendChild(option);
    });

    // Update description
    descriptionText.textContent = config.description;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const factTypeSelect = document.getElementById('fact_type');
    if (factTypeSelect) {
        updateGrammarFactLanguages();
        factTypeSelect.addEventListener('change', updateGrammarFactLanguages);
    }
});
</script>
{% endif %}
