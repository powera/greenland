{% extends "base.html" %}

{% block title %}Edit {{ lemma.lemma_text }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('lemmas.list_lemmas') }}">Lemmas</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('lemmas.view_lemma', lemma_id=lemma.id) }}">{{ lemma.lemma_text }}</a></li>
                <li class="breadcrumb-item active">Edit</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 offset-lg-2">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pencil-square"></i> Edit Lemma
            </div>
            <div class="card-body">
                <form method="post">
                    <!-- Lemma Text -->
                    <div class="mb-3">
                        <label for="lemma_text" class="form-label">Lemma Text <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="lemma_text" name="lemma_text"
                               value="{{ lemma.lemma_text }}" required>
                    </div>

                    <!-- Definition -->
                    <div class="mb-3">
                        <label for="definition_text" class="form-label">Definition <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="definition_text" name="definition_text"
                                  rows="3" required>{{ lemma.definition_text }}</textarea>
                    </div>

                    <!-- Disambiguation -->
                    <div class="mb-3">
                        <label for="disambiguation" class="form-label">Disambiguation</label>
                        <input type="text" class="form-control" id="disambiguation" name="disambiguation"
                               value="{{ lemma.disambiguation or '' }}"
                               placeholder="e.g., animal, computer, tool">
                        <small class="form-text text-muted">
                            Optional: Used to distinguish polysemes (e.g., "mouse (animal)" vs "mouse (computer)")
                        </small>
                    </div>

                    <!-- POS Type and Subtype -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="pos_type" class="form-label">POS Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="pos_type" name="pos_type" required>
                                <option value="">-- Select POS Type --</option>
                                {% for pos_type_option in pos_types %}
                                <option value="{{ pos_type_option }}" {% if pos_type_option == lemma.pos_type %}selected{% endif %}>
                                    {{ pos_type_option }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="pos_subtype" class="form-label">POS Subtype</label>
                            <select class="form-select" id="pos_subtype" name="pos_subtype">
                                <option value="">-- Select Subtype (optional) --</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>

                    <!-- Warning for type/subtype changes -->
                    <div class="alert alert-warning d-none" id="type_change_warning" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Warning:</strong>
                        Changing the POS type or subtype will:
                        <ul class="mb-0 mt-2">
                            <li>Generate a new GUID and tombstone the old one</li>
                            <li>Clear all translations</li>
                            <li>Delete all derivative forms (conjugations, declensions)</li>
                            <li>Mark the lemma as unverified</li>
                        </ul>
                    </div>

                    <!-- GUID -->
                    <div class="mb-3">
                        <label for="guid" class="form-label">GUID</label>
                        <input type="text" class="form-control" id="guid" name="guid"
                               value="{{ lemma.guid or '' }}"
                               placeholder="e.g., N01_001">
                        <small class="form-text text-muted">
                            Auto-generated when type/subtype changes. Can be manually overridden if needed.
                        </small>
                    </div>

                    <!-- Difficulty Level -->
                    <div class="mb-3">
                        <label for="difficulty_level" class="form-label">Base Difficulty Level</label>
                        <input type="number" class="form-control" id="difficulty_level" name="difficulty_level"
                               value="{{ lemma.difficulty_level if lemma.difficulty_level is not none else '' }}"
                               min="-1" max="20" placeholder="-1 or 1-20">
                        <small class="form-text text-muted">
                            Enter -1 to exclude from all languages, 1-20 for Trakaido level, or leave empty for no base level
                        </small>
                        {% if difficulty_stats %}
                            <div class="mt-2 p-2 bg-light border rounded">
                                <small class="text-muted">
                                    <strong>Difficulty levels for {{ lemma.pos_type }}{% if lemma.pos_subtype %} ({{ lemma.pos_subtype }}){% endif %}:</strong><br>
                                    {% for level in range(-1, 21) %}
                                        {% if level in difficulty_stats %}
                                            {% if level == -1 %}
                                                <span class="badge bg-warning text-dark me-1" title="{{ difficulty_stats[level] }} words">Excluded: {{ difficulty_stats[level] }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary me-1" title="{{ difficulty_stats[level] }} words">L{{ level }}: {{ difficulty_stats[level] }}</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </small>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Verified and Confidence -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="verified" name="verified"
                                       {% if lemma.verified %}checked{% endif %}>
                                <label class="form-check-label" for="verified">
                                    Verified
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="confidence" class="form-label">Confidence (0-1)</label>
                            <input type="number" class="form-control" id="confidence" name="confidence"
                                   value="{{ lemma.confidence }}" step="0.01" min="0" max="1">
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags (JSON)</label>
                        <input type="text" class="form-control" id="tags" name="tags"
                               value="{{ lemma.tags or '' }}"
                               placeholder="Optional JSON array">
                        <small class="form-text text-muted">JSON array format, e.g., ["tag1", "tag2"]</small>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3">{{ lemma.notes or '' }}</textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('lemmas.view_lemma', lemma_id=lemma.id) }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Text -->
        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="bi bi-info-circle"></i> Editing Tips</h6>
                <ul class="mb-0">
                    <li>Changes are logged to the operation_log table</li>
                    <li>Difficulty level: Use -1 to exclude, 1-20 for levels, or leave empty</li>
                    <li>Per-language difficulty overrides can be set on the view page</li>
                    <li>Translations can be edited from the view page</li>
                    <li><strong>Changing POS type/subtype will clear translations and derivative forms</strong></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// POS subtypes mapping from server
const posSubtypesMap = {{ pos_subtypes_map|safe }};

// Original values to detect changes
const originalPosType = {{ lemma.pos_type|tojson }};
const originalPosSubtype = {{ lemma.pos_subtype|tojson }};

// Function to update subtype dropdown based on selected POS type
function updateSubtypeDropdown() {
    const posTypeSelect = document.getElementById('pos_type');
    const posSubtypeSelect = document.getElementById('pos_subtype');
    const selectedPosType = posTypeSelect.value;

    // Clear current options except the first placeholder
    posSubtypeSelect.innerHTML = '<option value="">-- Select Subtype (optional) --</option>';

    // Add subtypes for selected POS type
    if (selectedPosType && posSubtypesMap[selectedPosType]) {
        posSubtypesMap[selectedPosType].forEach(subtype => {
            const option = document.createElement('option');
            option.value = subtype;
            option.textContent = subtype.replace(/_/g, ' ');

            // Select the current subtype if it matches
            if (subtype === originalPosSubtype && selectedPosType === originalPosType) {
                option.selected = true;
            }

            posSubtypeSelect.appendChild(option);
        });
    }

    // Check if values changed
    checkForTypeChanges();
}

// Function to show/hide warning when type or subtype changes
function checkForTypeChanges() {
    const posTypeSelect = document.getElementById('pos_type');
    const posSubtypeSelect = document.getElementById('pos_subtype');
    const warningDiv = document.getElementById('type_change_warning');

    const currentPosType = posTypeSelect.value;
    const currentPosSubtype = posSubtypeSelect.value;

    const typeChanged = currentPosType !== originalPosType;
    const subtypeChanged = currentPosSubtype !== originalPosSubtype;

    if (typeChanged || subtypeChanged) {
        warningDiv.classList.remove('d-none');
    } else {
        warningDiv.classList.add('d-none');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSubtypeDropdown();

    // Add event listeners
    document.getElementById('pos_type').addEventListener('change', updateSubtypeDropdown);
    document.getElementById('pos_subtype').addEventListener('change', checkForTypeChanges);
});
</script>
{% endblock %}
