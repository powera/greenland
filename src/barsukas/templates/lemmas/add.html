{% extends "base.html" %}

{% block title %}Add New Lemma{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('lemmas.list_lemmas') }}">Lemmas</a></li>
                <li class="breadcrumb-item active">Add New</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> Add New Lemma
            </div>
            <div class="card-body">
                <!-- Auto-populate section -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-robot"></i> Auto-Populate (Optional)</h5>
                        <p class="text-muted small">Use AI to automatically fill in definition, POS type, and subtype based on the word.</p>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="auto_word" class="form-label">Word</label>
                                <input type="text" class="form-control" id="auto_word">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="auto_lang" class="form-label">Translation Language (Optional)</label>
                                <select class="form-select" id="auto_lang">
                                    <option value="">None</option>
                                    <option value="lt">Lithuanian</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ko">Korean</option>
                                    <option value="fr">French</option>
                                    <option value="es">Spanish</option>
                                    <option value="de">German</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="sw">Swahili</option>
                                    <option value="vi">Vietnamese</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="auto_translation" class="form-label">Translation (Optional)</label>
                                <input type="text" class="form-control" id="auto_translation">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" onclick="autoPopulate()" id="auto_populate_btn">
                                <i class="bi bi-magic"></i> Auto-Populate Fields
                            </button>
                            <small class="text-muted ms-2" id="auto_populate_status"></small>
                        </div>
                    </div>
                </div>

                <form method="post">
                    <!-- Hidden fields to pass translation info -->
                    <input type="hidden" id="initial_translation_lang" name="initial_translation_lang">
                    <input type="hidden" id="initial_translation_text" name="initial_translation_text">

                    <div class="mb-3">
                        <label for="lemma_text" class="form-label">Lemma Text <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="lemma_text" name="lemma_text" required
                               placeholder="e.g., eat" onblur="checkWordExists()">
                        <small class="form-text text-muted">The base form of the word in English</small>
                        <div id="word_check_result" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="definition_text" class="form-label">Definition <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="definition_text" name="definition_text" rows="3" required
                                  placeholder="e.g., To consume food by mouth"></textarea>
                        <small class="form-text text-muted">Clear definition of the word</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="pos_type" class="form-label">POS Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="pos_type" name="pos_type" required onchange="updateSubtypeOptions()">
                                <option value="">Select POS type...</option>
                                <option value="noun">noun</option>
                                <option value="verb">verb</option>
                                <option value="adjective">adjective</option>
                                <option value="adverb">adverb</option>
                                <option value="pronoun">pronoun</option>
                                <option value="preposition">preposition</option>
                                <option value="conjunction">conjunction</option>
                                <option value="interjection">interjection</option>
                                <option value="determiner">determiner</option>
                                <option value="numeral">numeral</option>
                            </select>
                            <small class="form-text text-muted">Part of speech</small>
                        </div>
                        <div class="col-md-6">
                            <label for="pos_subtype" class="form-label">POS Subtype <span class="text-danger">*</span></label>
                            <select class="form-select" id="pos_subtype" name="pos_subtype" required>
                                <option value="">Select POS type first...</option>
                            </select>
                            <small class="form-text text-muted">Required for GUID generation</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="difficulty_level" class="form-label">Difficulty Level (Optional)</label>
                        <select class="form-select" id="difficulty_level" name="difficulty_level">
                            <option value="">Not set</option>
                            <option value="-1">Excluded (-1)</option>
                            {% for i in range(1, 21) %}
                                <option value="{{ i }}">Level {{ i }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Trakaido difficulty level (1-20), or -1 to exclude from wordlists</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>Note:</strong> After creating the lemma, you can add translations and other details on the lemma view page.
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('lemmas.list_lemmas') }}" class="btn btn-secondary">
                            <i class="bi bi-x"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Create Lemma
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// POS subtype mapping
const posSubtypes = {
    'noun': [
        'animal', 'body_part', 'building_structure', 'clothing_accessory',
        'concept_idea', 'emotion_feeling', 'food_drink', 'human',
        'material_substance', 'nationality', 'natural_feature', 'personal_name',
        'place_name', 'plant', 'small_movable_object', 'temporal_name',
        'time_period', 'tool_machine', 'unit_of_measurement'
    ],
    'verb': [
        'directional_movement', 'emotional_state', 'mental_state',
        'physical_action', 'possession'
    ],
    'adjective': [
        'color', 'definite_quantity', 'quality', 'sequence', 'shape'
    ],
    'adverb': [
        'location', 'other', 'style'
    ],
    'pronoun': [
        'pronoun_other'
    ],
    'conjunction': [
        'conjunction_other'
    ],
    'interjection': [
        'other'
    ],
    'numeral': [
        'definite_quantity'
    ],
    'preposition': [
        'preposition_other'
    ],
    'determiner': [
        'determiner_other'
    ]
};

// Format subtype for display (convert underscores to spaces, capitalize)
function formatSubtype(subtype) {
    return subtype.split('_').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function updateSubtypeOptions() {
    const posType = document.getElementById('pos_type').value;
    const subtypeSelect = document.getElementById('pos_subtype');

    // Clear current options
    subtypeSelect.innerHTML = '<option value="">None</option>';

    if (posType && posSubtypes[posType]) {
        const subtypes = posSubtypes[posType];
        if (subtypes.length > 0) {
            subtypes.forEach(subtype => {
                const option = document.createElement('option');
                option.value = subtype;
                option.textContent = formatSubtype(subtype);
                subtypeSelect.appendChild(option);
            });
        }
    }

    // Also trigger word check when POS type changes
    checkWordExists();
}

function checkWordExists() {
    const lemmaText = document.getElementById('lemma_text').value.trim();
    const posType = document.getElementById('pos_type').value;
    const resultDiv = document.getElementById('word_check_result');

    if (!lemmaText) {
        resultDiv.innerHTML = '';
        return;
    }

    // Show loading indicator
    resultDiv.innerHTML = '<small class="text-muted"><i class="bi bi-hourglass-split"></i> Checking...</small>';

    // Build query parameters
    const params = new URLSearchParams({
        search: lemmaText
    });
    if (posType) {
        params.append('pos_type', posType);
    }

    // Fetch results
    fetch(`{{ url_for('api.check_lemma_exists') }}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.exact_match) {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning py-2">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Exact match found:</strong>
                        <a href="{{ url_for('lemmas.view_lemma', lemma_id=0) }}".replace('0', data.exact_match.id) target="_blank">
                            ${data.exact_match.lemma_text} (${data.exact_match.pos_type})
                        </a>
                    </div>
                `;
            } else if (data.similar_matches && data.similar_matches.length > 0) {
                const matches = data.similar_matches.slice(0, 3).map(m =>
                    `<a href="{{ url_for('lemmas.view_lemma', lemma_id=0) }}".replace('0', m.id) target="_blank">${m.lemma_text} (${m.pos_type})</a>`
                ).join(', ');
                resultDiv.innerHTML = `
                    <div class="alert alert-info py-2">
                        <i class="bi bi-info-circle"></i>
                        <strong>Similar words found:</strong> ${matches}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> No existing matches found</small>';
            }
        })
        .catch(error => {
            console.error('Error checking word:', error);
            resultDiv.innerHTML = '';
        });
}

function autoPopulate() {
    const word = document.getElementById('auto_word').value.trim();
    const langCode = document.getElementById('auto_lang').value;
    const translation = document.getElementById('auto_translation').value.trim();
    const statusDiv = document.getElementById('auto_populate_status');
    const btn = document.getElementById('auto_populate_btn');

    if (!word) {
        statusDiv.innerHTML = '<span class="text-danger">Please enter a word</span>';
        return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    statusDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Calling AI...';

    // Build query parameters
    const params = new URLSearchParams({ word });
    if (langCode && translation) {
        params.append('lang_code', langCode);
        params.append('translation', translation);
    }

    // Call API
    fetch(`{{ url_for('api.auto_populate_lemma') }}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fill in the form fields
                document.getElementById('lemma_text').value = word;
                document.getElementById('definition_text').value = data.definition;
                document.getElementById('pos_type').value = data.pos_type;

                // Update subtypes dropdown and select the appropriate one
                updateSubtypeOptions();
                // Give the dropdown a moment to update
                setTimeout(() => {
                    document.getElementById('pos_subtype').value = data.pos_subtype;
                }, 100);

                // Set difficulty level if suggested
                if (data.suggested_difficulty_level) {
                    document.getElementById('difficulty_level').value = data.suggested_difficulty_level;
                }

                // Store translation info in hidden fields if provided
                if (langCode && translation) {
                    document.getElementById('initial_translation_lang').value = langCode;
                    document.getElementById('initial_translation_text').value = translation;
                }

                // Show success message with difficulty suggestion
                let message = '<span class="text-success"><i class="bi bi-check-circle"></i> Fields populated!</span>';
                if (data.suggested_difficulty_level) {
                    message += `<br><small>Set difficulty level to ${data.suggested_difficulty_level} (max for this subtype)</small>`;
                }
                if (langCode && translation) {
                    message += `<br><small>Translation (${langCode.toUpperCase()}: ${translation}) will be saved</small>`;
                }
                statusDiv.innerHTML = message;

                // Trigger word existence check
                checkWordExists();
            } else {
                statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</span>`;
            }
        })
        .catch(error => {
            console.error('Error auto-populating:', error);
            statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${error.message}</span>`;
        })
        .finally(() => {
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-magic"></i> Auto-Populate Fields';
        });
}
</script>
{% endblock %}
